Index: Linux-PAM/configure.in
===================================================================
--- Linux-PAM/configure.in.orig
+++ Linux-PAM/configure.in
@@ -385,11 +385,14 @@
     AC_DEFINE([WITH_SELINUX], 1, [Defined if SE Linux support is compiled in])
 fi
 
+AC_CHECK_LIB([cap], [cap_init], LIBCAP="-lcap", LIBCAP="")
+AC_SUBST(LIBCAP)
+
 dnl Checks for header files.
 AC_HEADER_DIRENT
 AC_HEADER_STDC
 AC_HEADER_SYS_WAIT
-AC_CHECK_HEADERS(fcntl.h limits.h malloc.h sys/file.h sys/ioctl.h sys/time.h syslog.h net/if.h termio.h unistd.h sys/fsuid.h inittypes.h)
+AC_CHECK_HEADERS(fcntl.h limits.h malloc.h sys/file.h sys/ioctl.h sys/time.h syslog.h net/if.h termio.h unistd.h sys/fsuid.h inittypes.h sys/capability.h)
 
 AC_CHECK_HEADERS(crypt.h)
 
Index: Linux-PAM/modules/pam_limits/pam_limits.c
===================================================================
--- Linux-PAM/modules/pam_limits/pam_limits.c.orig
+++ Linux-PAM/modules/pam_limits/pam_limits.c
@@ -19,6 +19,10 @@
 
 #include "config.h"
 
+#ifdef HAVE_SYS_CAPABILITY_H
+#include <sys/capability.h>
+#include <sys/prctl.h>
+#endif /* HAVE_SYS_CAPABILITY_H */
 #include <stdio.h>
 #include <unistd.h>
 #include <string.h>
@@ -76,6 +80,10 @@
 			      specific user or to count all logins */
     int priority;	 /* the priority to run user process with */
     char chroot_dir[8092]; /* directory to chroot into */
+#ifdef HAVE_SYS_CAPABILITY_H
+    cap_t capabilities; /*capability handle*/
+    int caps_set;
+#endif /* HAVE_SYS_CAPABILITY_H */
     struct user_limits_struct limits[RLIM_NLIMITS];
     char conf_file[BUFSIZ];
     int utmp_after_pam_call;
@@ -87,6 +95,7 @@
 
 #define LIMIT_PRI RLIM_NLIMITS+3
 #define LIMIT_CHROOT RLIM_NLIMITS+4
+#define LIMIT_CAPS RLIM_NLIMITS+5
 
 #define LIMIT_SOFT  1
 #define LIMIT_HARD  2
@@ -274,6 +283,10 @@
     pl->login_limit = -2;
     pl->login_limit_def = LIMITS_DEF_NONE;
 
+#ifdef HAVE_SYS_CAPABILITY_H
+    pl->capabilities = cap_init();
+    pl->caps_set = 0;
+#endif /* HAVE_SYS_CAPABILITY_H */
     pl->chroot_dir[0] = '\0';
     
     return retval;
@@ -348,6 +361,10 @@
 	limit_item = LIMIT_PRI;
     } else if (strcmp(lim_item, "chroot") == 0) {
 	limit_item = LIMIT_CHROOT;
+#ifdef HAVE_SYS_CAPABILITY_H
+    } else if (strcmp(lim_item, "capabilities") == 0) {
+	limit_item = LIMIT_CAPS;
+#endif /* HAVE_SYS_CAPABILITY_H */
     } else {
         pam_syslog(pamh, LOG_DEBUG, "unknown limit item '%s'", lim_item);
         return;
@@ -438,6 +455,13 @@
 
     if (limit_item == LIMIT_CHROOT)
 	strncpy(pl->chroot_dir, value_orig, sizeof(pl->chroot_dir));
+#ifdef HAVE_SYS_CAPABILITY_H
+    else if (limit_item == LIMIT_CAPS) {
+	pl->capabilities = cap_from_text(value_orig);
+	prctl(PR_SET_KEEPCAPS, 1);
+	pl->caps_set = 1;
+    }
+#endif
     else if ( (limit_item != LIMIT_LOGIN)
 	 && (limit_item != LIMIT_NUMSYSLOGINS)
 	 && (limit_item != LIMIT_PRI) ) {
@@ -649,6 +673,12 @@
 	if (i != 0)
 	    retval = LIMIT_ERR;
     }
+#ifdef HAVE_SYS_CAPABILITY_H
+    if (!retval && pl->caps_set) {
+	retval = cap_set_proc(pl->capabilities) ? LIMIT_ERR : 0;
+	cap_free(pl->capabilities);
+    }
+#endif /* HAVE_SYS_CAPABILITY_H */
     return retval;
 }
 
Index: Linux-PAM/modules/pam_limits/Makefile.am
===================================================================
--- Linux-PAM/modules/pam_limits/Makefile.am.orig
+++ Linux-PAM/modules/pam_limits/Makefile.am
@@ -26,9 +26,10 @@
 
 secureconf_DATA = limits.conf
 
+pam_limits_la_LIBADD = @LIBCAP@
+
 if ENABLE_REGENERATE_MAN
 noinst_DATA = README
 README: pam_limits.8.xml limits.conf.5.xml
 -include $(top_srcdir)/Make.xml.rules
 endif
-
